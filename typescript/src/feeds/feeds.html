<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBC Feeds</title>
    <script>
        let url = "https://www.bbc.co.uk/podcasts.opml";

        async function load(url) {
            async function parseXml(text) {
                return await (new window.DOMParser()).parseFromString(text, "text/xml");
            }

            let text = localStorage.getItem(url);
            let data;

            if (text) {
                data = await parseXml(text);
                let modified = data.querySelector("dateModified");
                if (modified) {
                    modified = new Date(modified.textContent);
                    console.log("Saved data from", modified);
                    const hour = 60 * 60 * 1000;
                    if ((Date.now() - modified) < (23 * hour)) {
                        console.log("Using saved data");
                        return data;
                    }
                }
            }

            try {
                console.log("Fetching data");
                let response = await fetch(url);
                text = await response.text();
                data = await parseXml(text);
                localStorage.setItem(url, text);
            } catch (e) {
                console.log("Fetch failed");
            }

            return data;
        }

        async function getFeeds() {
            let genreSet = {};
            let channels = {};
            let data = await load(url);
            let results = [...data.querySelectorAll("outline[type='rss']")];
            console.log(results);
            let feeds = results.map(o => {
                let genres = o.getAttribute("bbcgenres").split(",").map(g => g.trim());
                
                let title = o.getAttribute("text").trim();
                let sortTitle = title.replace(/^(?<article>(the)|(an?)|(l[aeo]s?)|(un[ae]?)|(un[ao]s)|(des)) (?<remainder>.*)$/i, "$<remainder>");
                let result = {
                    channel: o.parentNode.getAttribute("text").trim(),
                    title,
                    sortTitle,
                    description: o.getAttribute("description").trim(),
                    rss: o.getAttribute("xmlUrl"),
                    html: o.getAttribute("htmlUrl"),
                    image: o.getAttribute("imageHref"),
                    genres,
                    typicalDurationMinutes: parseInt(o.getAttribute("typicalDurationMins"), 10) || undefined,
                    // language: o.getAttribute("language"), // Doesn't match language of text or content
                };

                for (let genre of genres) {
                    let g = genreSet[genre];
                    if (g === undefined) {
                        g = [];
                        genreSet[genre] = g;
                    }
                    g.push(result);
                }

                let c = channels[result.channel];
                if (c === undefined) {
                    c = [];
                    channels[result.channel] = c;
                }
                c.push(result);

                return result;
            });
            
            feeds.sort((a, b) => a.sortTitle.localeCompare(b.sortTitle, undefined, { numeric: true, ignorePunctuation: true, sensitivity: "base" }) );

            let result = { feeds, genres: genreSet, channels };
            console.log(result);
            return result;
        }

        function feedToHTML(feed) {
            let e = document.createElement("div");
            e.innerHTML = `
            <h1 class="title"></h1>
            <img class="image">
            <p class="description"></p>
            <p class="genres"></p>
            <p class="duration"></p>
            <a class="html">HTML</a>
            <a class="rss">RSS</a>
            `;

            e.querySelector(".image").src = feed.image;
            e.querySelector(".title").innerText = feed.title;
            e.querySelector(".description").innerText = feed.description;
            e.querySelector(".genres").innerText = feed.genres.join(", ");
            e.querySelector(".duration").innerText = feed.typicalDurationMinutes || "";
            e.querySelector(".html").href = feed.html;
            e.querySelector(".rss").href = feed.rss;

            return e;
        }

        function ready(callback) {
            if (document.readyState != "loading") {
                callback();
            } else if (document.addEventListener) {
                document.addEventListener('DOMContentLoaded', callback);
            }
        }

        function init() {
            getFeeds().then(result => {
                document.body.append(...result.feeds.map(feedToHTML));
                console.log("Done");
            });
        }

        ready(init);

    </script>
</head>

<body>

</body>

</html>