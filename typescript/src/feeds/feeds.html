<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBC Feeds</title>
    <script>
        let url = "https://www.bbc.co.uk/podcasts.opml";

        async function load(url) {
            async function parseXml(text) {
                return await (new window.DOMParser()).parseFromString(text, "text/xml");
            }

            let text = localStorage.getItem(url);
            let data;

            if (text) {
                data = await parseXml(text);
                let modified = data.querySelector("dateModified");
                if (modified) {
                    modified = new Date(modified.textContent);
                    console.log("Saved data from", modified);
                    const hour = 60 * 60 * 1000;
                    if ((Date.now() - modified) < (23 * hour)) {
                        console.log("Using saved data");
                        return data;
                    }
                }
            }

            try {
                console.log("Fetching data");
                let response = await fetch(url);
                text = await response.text();
                data = await parseXml(text);
                localStorage.setItem(url, text);
            } catch (e) {
                console.log("Fetch failed");
            }

            return data;
        }

        async function getFeeds() {
            let data = await load(url);
            let results = [...data.querySelectorAll("outline[type='rss']")];
            console.log(results);
            let feeds = results.map(o => {
                return {
                    channel: o.parentNode.getAttribute("text"),
                    title: o.getAttribute("text"),
                    description: o.getAttribute("description"),
                    rss: o.getAttribute("xmlUrl"),
                    html: o.getAttribute("htmlUrl"),
                    image: o.getAttribute("imageHref"),
                    genres: o.getAttribute("bbcgenres"),
                    typicalDurationMinutes: parseInt(o.getAttribute("typicalDurationMins"), 10) || undefined,
                    // language: o.getAttribute("language"), // Doesn't match language of text or content
                };
            });
            console.log(feeds);
            return feeds;
        }

        function feedToHTML(feed) {
            let e = document.createElement("div");
            e.innerHTML = `
            <h1 class="title"></h1>
            <img class="image">
            <p class="description"></p>
            <p class="genres"></p>
            <p class="duration"></p>
            `;

            e.querySelector(".image").src = feed.image;
            e.querySelector(".title").innerText = feed.title;
            e.querySelector(".description").innerText = feed.description;
            e.querySelector(".genres").innerText = feed.genres;
            e.querySelector(".duration").innerText = feed.typicalDurationMinutes || "";

            return e;
        }

        function ready(callback) {
            if (document.readyState != "loading") {
                callback();
            } else if (document.addEventListener) {
                document.addEventListener('DOMContentLoaded', callback);
            }
        }

        function init() {
            getFeeds().then(feeds => {
                document.body.append(...feeds.map(feedToHTML));
                console.log("Done");
            });
        }

        ready(init);

    </script>
</head>

<body>

</body>

</html>